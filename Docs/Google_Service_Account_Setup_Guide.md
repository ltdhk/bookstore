# Google Play Console 服务账号设置详细指南

本文档详细说明如何在 Google Play Console 中设置和关联服务账号，用于应用内购买（IAP）验证。

## 目录
- [前置条件](#前置条件)
- [创建 Google Cloud 服务账号](#创建-google-cloud-服务账号)
- [关联服务账号到 Play Console](#关联服务账号到-play-console)
- [配置权限](#配置权限)
- [测试验证](#测试验证)
- [常见问题](#常见问题)

---

## 前置条件

- ✅ Google Play Console 开发者账号
- ✅ 应用已在 Play Console 中创建
- ✅ Google Cloud Platform (GCP) 账号
- ✅ 应用的 Package Name: `com.novel.pop`

---

## 创建 Google Cloud 服务账号

### 步骤 1：创建 GCP 项目

1. 访问 [Google Cloud Console](https://console.cloud.google.com/)
2. 点击顶部的项目选择器
3. 点击 **新建项目**
4. 输入项目名称：`NovelPop IAP`
5. 点击 **创建**

### 步骤 2：启用 Google Play Android Developer API

1. 在 GCP Console 中，确保选择了刚创建的项目
2. 点击左侧菜单 **API 和服务 > 库**
3. 在搜索框中输入：`Google Play Android Developer API`
4. 点击搜索结果中的 **Google Play Android Developer API**
5. 点击 **启用** 按钮
6. 等待 API 启用完成

### 步骤 3：创建服务账号

1. 在 GCP Console 左侧菜单中，点击 **IAM 和管理 > 服务账号**
2. 点击顶部的 **+ 创建服务账号**
3. 填写服务账号详细信息：
   ```
   服务账号名称：novelpop-iap-backend
   服务账号 ID：novelpop-iap-backend（自动生成）
   服务账号说明：Service account for NovelPop in-app purchase receipt verification
   ```
4. 点击 **创建并继续**
5. **授予此服务账号对项目的访问权限**：暂时跳过，点击 **继续**
6. **向用户授予访问此服务账号的权限**：跳过，点击 **完成**

### 步骤 4：下载服务账号密钥

1. 在服务账号列表中，找到刚创建的 `novelpop-iap-backend`
2. 点击服务账号的邮箱地址（形如：`novelpop-iap-backend@project-id.iam.gserviceaccount.com`）
3. 点击顶部的 **密钥** 标签
4. 点击 **添加密钥 > 创建新密钥**
5. 选择 **JSON** 格式
6. 点击 **创建**
7. JSON 密钥文件会自动下载到您的电脑
8. **重要**：将下载的 JSON 文件重命名为 `google-service-account.json`

**⚠️ 安全提示**：
- 请妥善保管此 JSON 文件
- 不要将其提交到 Git 仓库
- 不要分享给他人

---

## 关联服务账号到 Play Console

### 步骤 1：打开 Play Console

1. 访问：https://play.google.com/console/
2. 使用您的开发者账号登录

### 步骤 2：进入设置页面

**方法 A：通过所有应用入口**
1. 在 Play Console 首页，点击左上角的 **三条横线菜单图标** ☰
2. 向下滚动，找到 **设置** 部分
3. 点击 **API 访问权限**

**方法 B：通过具体应用入口**
1. 在 Play Console 首页，选择您的应用 **NovelPop**
2. 点击左侧菜单底部的 **设置**
3. 点击 **API 访问权限**

### 步骤 3：关联 Google Cloud 项目

如果这是第一次设置，您会看到：

```
┌─────────────────────────────────────────────┐
│  使用 Google Cloud Platform 项目             │
│                                             │
│  要使用 Google Play Developer API，          │
│  需要关联一个 Google Cloud Platform 项目。   │
│                                             │
│          [关联] 或 [创建新项目]              │
└─────────────────────────────────────────────┘
```

1. 点击 **关联** 按钮
2. 在弹出的对话框中，选择您刚才创建的项目：`NovelPop IAP`
3. 点击 **关联**
4. 等待关联完成（可能需要几分钟）

**如果已经关联了其他项目**：
- 页面会显示 "已关联的 Google Cloud Platform 项目"
- 您可以取消关联旧项目，然后关联新项目
- 或者直接使用现有项目

### 步骤 4：找到服务账号

关联完成后，页面会显示：

```
┌─────────────────────────────────────────────────────────────────┐
│ 服务账号                                                         │
├─────────────────────────────────────────────────────────────────┤
│ ⚠️ 您有 1 个服务账号等待授予访问权限                             │
│                                                                 │
│ 📧 novelpop-iap-backend@project-id.iam.gserviceaccount.com     │
│    创建时间：刚刚                                                │
│    状态：等待授予访问权限                                        │
│                                                                 │
│                           [授予访问权限] [移除访问权限]          │
└─────────────────────────────────────────────────────────────────┘
```

### 步骤 5：授予访问权限

1. 找到您的服务账号邮箱：`novelpop-iap-backend@project-id.iam.gserviceaccount.com`
2. 点击右侧的 **授予访问权限** 按钮
3. 在弹出的对话框中，会显示权限设置页面

---

## 配置权限

在授予访问权限的对话框中，您需要配置以下权限：

### 账号权限

找到 **账号权限** 部分，选择以下选项：

#### ✅ 必选权限

1. **查看财务数据、订单和订阅取消调查回复**
   - 英文：View financial data, orders, and cancellation survey responses
   - 用途：允许服务账号查看订单和订阅信息

2. **管理订单和订阅**
   - 英文：Manage orders and subscriptions
   - 用途：允许服务账号验证和管理订阅

#### 📋 完整权限列表（按字母顺序）

在对话框中，您会看到类似这样的权限列表：

```
□ 创建、编辑和删除草稿应用
□ 创建和编辑编辑信息
□ 发布应用、APK 和 App Bundle 到各个轨道
☑ 查看应用信息和下载批量报告（不包括财务数据）
☑ 查看财务数据、订单和订阅取消调查回复
□ 管理生产 APK
☑ 管理订单和订阅
□ 管理 Store 显示信息、内容分级和安装配置
□ 管理测试人员和封闭式测试轨道
□ 回复用户评价
```

**重要提示**：
- ✅ 必须勾选：**查看财务数据、订单和订阅取消调查回复**
- ✅ 必须勾选：**管理订单和订阅**
- ✅ 建议勾选：**查看应用信息和下载批量报告**（用于查看订阅统计）
- ❌ 不要勾选其他权限（遵循最小权限原则）

### 应用访问权限

在权限对话框的下方，找到 **应用访问权限** 部分：

```
应用访问权限
此服务账号可以访问：

○ 所有当前和未来的应用
● 仅特定应用

  ☑ NovelPop (com.novel.pop)
```

1. 选择 **仅特定应用**
2. 勾选 **NovelPop (com.novel.pop)**

### 保存设置

1. 检查所有权限是否正确勾选
2. 点击右下角的 **邀请用户** 或 **应用更改** 按钮
3. 等待几秒钟，直到看到成功提示

---

## 验证设置

### 检查服务账号状态

返回 **设置 > API 访问权限** 页面，您应该看到：

```
┌─────────────────────────────────────────────────────────────────┐
│ 服务账号                                                         │
├─────────────────────────────────────────────────────────────────┤
│ ✅ 已授予访问权限的服务账号 (1)                                  │
│                                                                 │
│ 📧 novelpop-iap-backend@project-id.iam.gserviceaccount.com     │
│    权限：财务数据, 订单管理                                      │
│    可访问应用：NovelPop                                          │
│    最后修改时间：刚刚                                            │
│                                                                 │
│                           [管理权限] [移除访问权限]              │
└─────────────────────────────────────────────────────────────────┘
```

### 测试 API 访问

配置完成后，等待 **10-15 分钟** 让权限生效，然后可以测试：

1. 将 `google-service-account.json` 放到后端项目中：
   ```
   Backend/src/main/resources/google-service-account.json
   ```

2. 更新 `application.yml`：
   ```yaml
   iap:
     google:
       package-name: com.novel.pop
       service-account-file: classpath:google-service-account.json
   ```

3. 重启后端服务

4. 测试收据验证（需要有真实的购买记录）

---

## 常见问题

### Q1: 找不到"API 访问权限"菜单

**解决方案**：

1. **确认账号权限**：
   - 您的 Google 账号必须是 Play Console 的**所有者**或**管理员**
   - 如果您不是所有者，联系所有者授予您权限

2. **检查菜单位置**：
   - 点击左上角 ☰ 菜单图标
   - 向下滚动到 **设置** 部分
   - **API 访问权限** 应该在设置列表中

3. **清除浏览器缓存**：
   - 刷新页面或清除浏览器缓存
   - 重新登录 Play Console

### Q2: 没有看到服务账号

**原因**：服务账号尚未出现在 Play Console 中

**解决方案**：

1. **确认 GCP 项目已关联**：
   - 在 **设置 > API 访问权限** 页面
   - 确认顶部显示 "已关联的 Google Cloud Platform 项目"
   - 确认项目名称正确

2. **等待同步**：
   - 创建服务账号后，可能需要 **5-10 分钟** 才会出现在 Play Console
   - 刷新页面重试

3. **检查服务账号是否属于正确的项目**：
   - 在 GCP Console 中，确认服务账号在正确的项目下
   - 确认项目 ID 与 Play Console 关联的项目匹配

### Q3: 服务账号显示"等待授予访问权限"

**解决方案**：

1. 点击服务账号右侧的 **授予访问权限** 按钮
2. 勾选所需权限
3. 点击 **应用更改**

### Q4: 授予权限后仍然无法访问 API

**可能原因**：

1. **权限未生效**：
   - 等待 10-15 分钟让权限生效
   - 清除应用缓存并重启

2. **权限不足**：
   - 确认勾选了 **查看财务数据** 和 **管理订单和订阅**
   - 返回权限设置页面检查

3. **JSON 密钥文件错误**：
   - 确认 JSON 文件完整且未被修改
   - 确认文件路径配置正确
   - 确认文件权限允许应用读取

### Q5: 收据验证返回 401 错误

**解决方案**：

1. **检查权限**：
   ```bash
   # 在 Play Console > 设置 > API 访问权限
   # 确认服务账号有以下权限：
   ✓ 查看财务数据、订单和订阅取消调查回复
   ✓ 管理订单和订阅
   ```

2. **检查应用访问**：
   - 确认服务账号可以访问 `com.novel.pop` 应用

3. **重新生成密钥**：
   - 如果问题持续，在 GCP Console 中删除旧密钥
   - 创建新的 JSON 密钥
   - 更新后端配置

### Q6: 如何撤销服务账号访问？

**步骤**：

1. 进入 Play Console > **设置 > API 访问权限**
2. 找到要撤销的服务账号
3. 点击右侧的 **移除访问权限**
4. 确认撤销操作

---

## 安全最佳实践

### 1. 最小权限原则

- ✅ 只授予必需的权限
- ❌ 不要授予 "所有当前和未来的应用" 访问权限
- ❌ 不要授予发布应用、管理测试人员等不必要的权限

### 2. 密钥管理

- ✅ 使用环境变量存储密钥文件路径
- ✅ 不要将 JSON 密钥文件提交到 Git
- ✅ 定期轮换服务账号密钥（建议每 90 天）
- ✅ 为不同环境（开发、生产）使用不同的服务账号

### 3. 监控和审计

- ✅ 在 GCP Console 中启用审计日志
- ✅ 定期检查服务账号活动
- ✅ 设置告警，监控异常 API 调用

### 4. 密钥轮换步骤

1. 在 GCP Console 中创建新密钥
2. 更新后端配置使用新密钥
3. 测试新密钥是否工作正常
4. 删除旧密钥

---

## 相关链接

- **Google Play Console**: https://play.google.com/console/
- **Google Cloud Console**: https://console.cloud.google.com/
- **Google Play Developer API 文档**: https://developers.google.com/android-publisher
- **服务账号文档**: https://cloud.google.com/iam/docs/service-accounts

---

**文档版本**: 1.0
**最后更新**: 2025-12-03
**应用**: NovelPop (com.novel.pop)
